<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Services - HTTPå®¢æˆ·ç«¯æ¼”ç¤º</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            background: white;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #6C5CE7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #5a4fcf;
        }
        .button.success {
            background: #00b894;
        }
        .button.danger {
            background: #e17055;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .feature-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ ç°ä»£åŒ–HTTPå®¢æˆ·ç«¯æ¼”ç¤º</h1>
        <p>åŸºäºKyåº“æ„å»ºçš„ä¼ä¸šçº§HTTPå®¢æˆ·ç«¯ï¼Œæ”¯æŒé‡è¯•ã€ç¼“å­˜ã€æ‹¦æˆªå™¨ç­‰é«˜çº§åŠŸèƒ½</p>
        <p><strong>ç«¯å£: 9101</strong> | <strong>æŠ€æœ¯æ ˆ: Ky + Vite + ES Modules</strong></p>
    </div>

    <div class="grid">
        <div class="feature-card">
            <h3>ğŸŒ HTTPå®¢æˆ·ç«¯ç‰¹æ€§</h3>
            <ul style="text-align: left;">
                <li>åŸºäºç°ä»£Fetch API</li>
                <li>è‡ªåŠ¨é‡è¯•æœºåˆ¶</li>
                <li>è¯·æ±‚/å“åº”æ‹¦æˆªå™¨</li>
                <li>æ™ºèƒ½ç¼“å­˜ç®¡ç†</li>
                <li>æ–‡ä»¶ä¸Šä¼ æ”¯æŒ</li>
                <li>è®¤è¯ä»¤ç‰Œç®¡ç†</li>
            </ul>
        </div>
        <div class="feature-card">
            <h3>ğŸ® æ¸¸æˆæœåŠ¡API</h3>
            <ul style="text-align: left;">
                <li>çƒ­é—¨æ¸¸æˆè·å–</li>
                <li>æ¸¸æˆåˆ†ç±»ç®¡ç†</li>
                <li>æ¸¸æˆæœç´¢åŠŸèƒ½</li>
                <li>æ¸¸æˆè¯¦æƒ…æŸ¥è¯¢</li>
                <li>å“åº”å¼æ•°æ®ç¼“å­˜</li>
            </ul>
        </div>
        <div class="feature-card">
            <h3>ğŸ‘¤ ç”¨æˆ·æœåŠ¡API</h3>
            <ul style="text-align: left;">
                <li>ç”¨æˆ·è®¤è¯ç™»å½•</li>
                <li>ç”¨æˆ·èµ„æ–™ç®¡ç†</li>
                <li>åå¥½è®¾ç½®ä¿å­˜</li>
                <li>å¤´åƒä¸Šä¼ åŠŸèƒ½</li>
                <li>æ‰¹é‡æ“ä½œæ”¯æŒ</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ® æ¸¸æˆæœåŠ¡APIæµ‹è¯•</h3>
        <button class="button" onclick="testFeaturedGames()">è·å–çƒ­é—¨æ¸¸æˆ</button>
        <button class="button" onclick="testGameCategories()">è·å–æ¸¸æˆåˆ†ç±»</button>
        <button class="button" onclick="testSearchGames()">æœç´¢æ¸¸æˆ</button>
        <button class="button" onclick="testGameDetail()">è·å–æ¸¸æˆè¯¦æƒ…</button>
        <div id="gameResult" class="result" style="display: none;">
            <pre id="gameResultContent"></pre>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ‘¤ ç”¨æˆ·æœåŠ¡APIæµ‹è¯•</h3>
        <button class="button success" onclick="testUserLogin()">ç”¨æˆ·ç™»å½•</button>
        <button class="button" onclick="testUserProfile()">è·å–ç”¨æˆ·èµ„æ–™</button>
        <button class="button" onclick="testUpdateProfile()">æ›´æ–°ç”¨æˆ·èµ„æ–™</button>
        <button class="button" onclick="testUserPreferences()">è·å–ç”¨æˆ·åå¥½</button>
        <button class="button" onclick="testUploadAvatar()">ä¸Šä¼ å¤´åƒ</button>
        <div id="userResult" class="result" style="display: none;">
            <pre id="userResultContent"></pre>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ”§ HTTPå®¢æˆ·ç«¯åŠŸèƒ½æµ‹è¯•</h3>
        <button class="button" onclick="testHttpClientFeatures()">æµ‹è¯•åŸºæœ¬åŠŸèƒ½</button>
        <button class="button" onclick="testCacheFeatures()">æµ‹è¯•ç¼“å­˜åŠŸèƒ½</button>
        <button class="button danger" onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
        <button class="button" onclick="testRetryFeatures()">æµ‹è¯•é‡è¯•æœºåˆ¶</button>
        <button class="button" onclick="testAuthFeatures()">æµ‹è¯•è®¤è¯åŠŸèƒ½</button>
        <div id="httpResult" class="result" style="display: none;">
            <pre id="httpResultContent"></pre>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ“Š æœåŠ¡çŠ¶æ€ç›‘æ§</h3>
        <button class="button" onclick="testHealthStatus()">å¥åº·çŠ¶æ€æ£€æŸ¥</button>
        <button class="button" onclick="clearAllCache()">æ¸…ç©ºæ‰€æœ‰ç¼“å­˜</button>
        <div id="status">åˆå§‹åŒ–ä¸­...</div>
    </div>

    <script type="module">
        import { api, serviceManager } from '/src/services.js'

        // å·¥å…·å‡½æ•°
        function showGameResult(content) {
            const resultDiv = document.getElementById('gameResult')
            const contentDiv = document.getElementById('gameResultContent')
            resultDiv.style.display = 'block'
            contentDiv.textContent = content
        }

        function showUserResult(content) {
            const resultDiv = document.getElementById('userResult')
            const contentDiv = document.getElementById('userResultContent')
            resultDiv.style.display = 'block'
            contentDiv.textContent = content
        }

        function showHttpResult(content) {
            const resultDiv = document.getElementById('httpResult')
            const contentDiv = document.getElementById('httpResultContent')
            resultDiv.style.display = 'block'
            contentDiv.textContent = content
        }

        // æµ‹è¯•å‡½æ•°
        window.testFunctions = {
            // æ¸¸æˆæœåŠ¡æµ‹è¯•
            async testFeaturedGames() {
                showGameResult('æ­£åœ¨è·å–çƒ­é—¨æ¸¸æˆ...')
                try {
                    const result = await api.getFeaturedGames({ limit: 4 })
                    showGameResult(JSON.stringify(result, null, 2))
                } catch (error) {
                    showGameResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testGameCategories() {
                showGameResult('æ­£åœ¨è·å–æ¸¸æˆåˆ†ç±»...')
                try {
                    const result = await api.getGameCategories()
                    showGameResult(JSON.stringify(result, null, 2))
                } catch (error) {
                    showGameResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testSearchGames() {
                showGameResult('æ­£åœ¨æœç´¢æ¸¸æˆ...')
                try {
                    const result = await api.searchGames('éŸ³ä¹', { limit: 3 })
                    showGameResult(JSON.stringify(result, null, 2))
                } catch (error) {
                    showGameResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testGameDetail() {
                showGameResult('æ­£åœ¨è·å–æ¸¸æˆè¯¦æƒ…...')
                try {
                    const result = await api.getGameDetail(1)
                    showGameResult(JSON.stringify(result, null, 2))
                } catch (error) {
                    showGameResult(`é”™è¯¯: ${error.message}`)
                }
            },

            // ç”¨æˆ·æœåŠ¡æµ‹è¯•
            async testUserLogin() {
                showUserResult('æ­£åœ¨æµ‹è¯•ç”¨æˆ·ç™»å½•...')
                try {
                    const result = await api.login('player001', 'demo123')
                    showUserResult(`ç™»å½•æˆåŠŸ:
${JSON.stringify(result, null, 2)}`)
                } catch (error) {
                    showUserResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testUserProfile() {
                showUserResult('æ­£åœ¨è·å–ç”¨æˆ·èµ„æ–™...')
                try {
                    const result = await api.getUserProfile()
                    showUserResult(`ç”¨æˆ·èµ„æ–™:
${JSON.stringify(result, null, 2)}`)
                } catch (error) {
                    showUserResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testUpdateProfile() {
                showUserResult('æ­£åœ¨æ›´æ–°ç”¨æˆ·èµ„æ–™...')
                try {
                    const result = await api.updateUserProfile({
                        level: 16,
                        coins: 15000
                    })
                    showUserResult(`æ›´æ–°æˆåŠŸ:
${JSON.stringify(result, null, 2)}`)
                } catch (error) {
                    showUserResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testUserPreferences() {
                showUserResult('æ­£åœ¨è·å–ç”¨æˆ·åå¥½...')
                try {
                    const result = await api.getUserPreferences()
                    showUserResult(`ç”¨æˆ·åå¥½:
${JSON.stringify(result, null, 2)}`)
                } catch (error) {
                    showUserResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testUploadAvatar() {
                showUserResult('æ­£åœ¨æ¨¡æ‹Ÿä¸Šä¼ å¤´åƒ...')
                try {
                    const userService = await api.getUserService()
                    const result = await userService.uploadAvatar(null)
                    showUserResult(`ä¸Šä¼ æˆåŠŸ:
${JSON.stringify(result, null, 2)}`)
                } catch (error) {
                    showUserResult(`é”™è¯¯: ${error.message}`)
                }
            },

            // HTTPå®¢æˆ·ç«¯åŠŸèƒ½æµ‹è¯•
            async testHttpClientFeatures() {
                showHttpResult('æ­£åœ¨æµ‹è¯•HTTPå®¢æˆ·ç«¯åŸºæœ¬åŠŸèƒ½...')
                try {
                    const userService = await api.getUserService()
                    const httpClient = userService.getHttpClient()
                    
                    const results = {
                        clientInfo: {
                            library: 'Ky (è½»é‡çº§ç°ä»£HTTPå®¢æˆ·ç«¯)',
                            timeout: httpClient.config.timeout + 'ms',
                            retry: httpClient.config.retry + ' æ¬¡',
                            baseURL: httpClient.config.baseURL || '/api/users',
                            features: [
                                'âœ… åŸºäºFetch API',
                                'âœ… è‡ªåŠ¨JSONè§£æ',
                                'âœ… è¯·æ±‚/å“åº”æ‹¦æˆªå™¨',
                                'âœ… TypeScriptæ”¯æŒ',
                                'âœ… ç°ä»£æµè§ˆå™¨ä¼˜åŒ–'
                            ]
                        },
                        supportedMethods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD'],
                        advancedFeatures: [
                            'è‡ªåŠ¨é‡è¯•æœºåˆ¶',
                            'è¯·æ±‚ç¼“å­˜ç®¡ç†',
                            'æ–‡ä»¶ä¸Šä¼ æ”¯æŒ',
                            'è®¤è¯ä»¤ç‰Œç®¡ç†',
                            'é”™è¯¯å¤„ç†å¢å¼º',
                            'è¯·æ±‚å–æ¶ˆæ”¯æŒ'
                        ]
                    }
                    
                    showHttpResult(JSON.stringify(results, null, 2))
                } catch (error) {
                    showHttpResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testCacheFeatures() {
                showHttpResult('æ­£åœ¨æµ‹è¯•ç¼“å­˜åŠŸèƒ½...')
                try {
                    const gameService = await api.getGameService()
                    
                    // ç¬¬ä¸€æ¬¡è¯·æ±‚
                    const start1 = Date.now()
                    await gameService.getFeaturedGames({ limit: 2 })
                    const time1 = Date.now() - start1
                    
                    // ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆä»ç¼“å­˜ï¼‰
                    const start2 = Date.now()
                    await gameService.getFeaturedGames({ limit: 2 })
                    const time2 = Date.now() - start2
                    
                    const results = {
                        cacheTest: {
                            firstRequest: `${time1}ms (ä»ç½‘ç»œè·å–)`,
                            cachedRequest: `${time2}ms (ä»ç¼“å­˜è·å–)`,
                            improvement: `æé€Ÿ ${Math.round((time1 - time2) / time1 * 100)}%`,
                            cacheHit: time2 < time1 * 0.1
                        },
                        cacheStrategy: {
                            type: 'å†…å­˜ç¼“å­˜',
                            ttl: '5åˆ†é’Ÿ',
                            keyGeneration: 'URL + å‚æ•°å“ˆå¸Œ',
                            invalidation: 'æ”¯æŒæ‰‹åŠ¨æ¸…é™¤'
                        }
                    }
                    
                    showHttpResult(JSON.stringify(results, null, 2))
                } catch (error) {
                    showHttpResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testErrorHandling() {
                showHttpResult('æ­£åœ¨æµ‹è¯•é”™è¯¯å¤„ç†...')
                try {
                    const gameService = await api.getGameService()
                    
                    const testResults = []
                    
                    // æµ‹è¯•ä¸å­˜åœ¨çš„æ¸¸æˆ
                    try {
                        await gameService.getGameDetail(999)
                    } catch (error) {
                        testResults.push({
                            test: 'ä¸å­˜åœ¨èµ„æºæµ‹è¯•',
                            errorType: error.name || 'Error',
                            errorMessage: error.message,
                            handled: true
                        })
                    }
                    
                    const results = {
                        errorHandling: testResults,
                        features: [
                            'HTTPçŠ¶æ€ç å¤„ç†',
                            'ç½‘ç»œé”™è¯¯æ•è·',
                            'è¶…æ—¶é”™è¯¯å¤„ç†',
                            'è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯',
                            'é”™è¯¯é‡è¯•é€»è¾‘',
                            'é”™è¯¯æ—¥å¿—è®°å½•'
                        ],
                        benefits: [
                            'æå‡ç”¨æˆ·ä½“éªŒ',
                            'ä¾¿äºé—®é¢˜æ’æŸ¥',
                            'å¢å¼ºåº”ç”¨ç¨³å®šæ€§'
                        ]
                    }
                    
                    showHttpResult(JSON.stringify(results, null, 2))
                } catch (error) {
                    showHttpResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testRetryFeatures() {
                showHttpResult('æ­£åœ¨æµ‹è¯•é‡è¯•æœºåˆ¶...')
                try {
                    const userService = await api.getUserService()
                    const httpClient = userService.getHttpClient()
                    
                    const results = {
                        retryConfig: {
                            maxRetries: httpClient.config.retry,
                            timeout: httpClient.config.timeout + 'ms',
                            strategy: 'æŒ‡æ•°é€€é¿ç®—æ³•'
                        },
                        retryConditions: [
                            'ç½‘ç»œè¿æ¥é”™è¯¯',
                            '5xxæœåŠ¡å™¨é”™è¯¯',
                            '408è¯·æ±‚è¶…æ—¶',
                            '429è¯·æ±‚è¿‡äºé¢‘ç¹'
                        ],
                        benefits: [
                            'æé«˜è¯·æ±‚æˆåŠŸç‡',
                            'å¤„ç†ä¸´æ—¶ç½‘ç»œæ•…éšœ',
                            'å‡å°‘ç”¨æˆ·æ„ŸçŸ¥çš„é”™è¯¯'
                        ],
                        implementation: {
                            library: 'Kyå†…ç½®é‡è¯•æœºåˆ¶',
                            backoffStrategy: 'exponential',
                            jitter: 'éšæœºåŒ–å»¶è¿Ÿ',
                            circuitBreaker: 'æ–­è·¯å™¨æ¨¡å¼æ”¯æŒ'
                        }
                    }
                    
                    showHttpResult(JSON.stringify(results, null, 2))
                } catch (error) {
                    showHttpResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testAuthFeatures() {
                showHttpResult('æ­£åœ¨æµ‹è¯•è®¤è¯åŠŸèƒ½...')
                try {
                    const userService = await api.getUserService()
                    
                    // æµ‹è¯•ç™»å½•è·å–token
                    const loginResult = await userService.login('player001', 'demo123')
                    
                    const results = {
                        authentication: {
                            method: 'Bearer Token',
                            tokenReceived: !!loginResult.data.token,
                            tokenStorage: 'å†…å­˜å­˜å‚¨',
                            autoAttachment: 'è‡ªåŠ¨æ·»åŠ åˆ°è¯·æ±‚å¤´'
                        },
                        features: [
                            'JWTä»¤ç‰Œæ”¯æŒ',
                            'è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°',
                            'ä»¤ç‰Œè¿‡æœŸå¤„ç†',
                            'å¤šç§è®¤è¯æ–¹å¼',
                            'å®‰å…¨å­˜å‚¨ç­–ç•¥'
                        ],
                        securityMeasures: [
                            'è¯·æ±‚å¤´è‡ªåŠ¨æ³¨å…¥',
                            'ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸç®¡ç†',
                            'å®‰å…¨ä¼ è¾“ä¿è¯'
                        ]
                    }
                    
                    showHttpResult(JSON.stringify(results, null, 2))
                } catch (error) {
                    showHttpResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async testHealthStatus() {
                showHttpResult('æ­£åœ¨æ£€æŸ¥å¥åº·çŠ¶æ€...')
                try {
                    const result = await serviceManager.getHealthStatus()
                    showHttpResult(JSON.stringify(result, null, 2))
                } catch (error) {
                    showHttpResult(`é”™è¯¯: ${error.message}`)
                }
            },

            async clearAllCache() {
                try {
                    await serviceManager.clearAllCache()
                    document.getElementById('status').innerHTML = `
                        <div style="color: green;">âœ… æ‰€æœ‰ç¼“å­˜å·²æ¸…ç©º</div>
                        <div>æ¸…ç©ºæ—¶é—´: ${new Date().toLocaleString()}</div>
                    `
                } catch (error) {
                    document.getElementById('status').innerHTML = `
                        <div style="color: red;">âŒ æ¸…ç©ºç¼“å­˜å¤±è´¥: ${error.message}</div>
                    `
                }
            }
        }

        // ç»‘å®šåˆ°å…¨å±€
        Object.assign(window, window.testFunctions)

        // åˆå§‹åŒ–æœåŠ¡å¹¶æ›´æ–°çŠ¶æ€
        async function initServices() {
            try {
                await serviceManager.init()
                document.getElementById('status').innerHTML = `
                    <div style="color: green; margin-bottom: 10px;">âœ… æœåŠ¡åˆå§‹åŒ–å®Œæˆ</div>
                    <div><strong>å·²æ³¨å†ŒæœåŠ¡:</strong> ${serviceManager.getServiceNames().join(', ')}</div>
                    <div><strong>HTTPå®¢æˆ·ç«¯:</strong> Ky ${window.__KY_VERSION__ || '1.9.0'}</div>
                    <div><strong>åˆå§‹åŒ–æ—¶é—´:</strong> ${new Date().toLocaleString()}</div>
                `
            } catch (error) {
                document.getElementById('status').innerHTML = `
                    <div style="color: red;">âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>
                `
            }
        }

        initServices()
    </script>
</body>
</html>